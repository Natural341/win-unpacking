module.exports=[78513,e=>{"use strict";var t=e.i(38492),r=e.i(84872),a=e.i(70799),n=e.i(30338),o=e.i(81164),s=e.i(71848),i=e.i(7940),u=e.i(97514),c=e.i(63734),l=e.i(82872),d=e.i(62363),p=e.i(49641),m=e.i(29642),h=e.i(52927),y=e.i(39125),f=e.i(34218),g=e.i(93695);e.i(21457);var v=e.i(19079),w=e.i(31338),A=e.i(48221),R=e.i(73954),P=e.i(62185);function S(e,t){let r=(0,P.toDate)(e,t?.in);return r.setHours(23,59,59,999),r}var k=e.i(47561),E=e.i(98699);async function C(e){try{var t,r;let a,n=e.nextUrl.searchParams,o=n.get("type"),s=n.get("startDate"),i=n.get("endDate");if(!o)return w.NextResponse.json({error:"Rapor tipi gereklidir (type parameter required)"},{status:400});let u=s?new Date(s):(0,R.startOfDay)((t=new Date,r=void 0,a=(0,P.toDate)(t,r?.in),isNaN(-30)?(0,k.constructFrom)(r?.in||t,NaN):(a.setDate(a.getDate()+-30),a))),c=i?S(new Date(i)):S(new Date);switch(o){case"sales":{let e=await A.prisma.sale.findMany({where:{createdAt:{gte:u,lte:c},status:"completed"},include:{items:{include:{product:{select:{id:!0,name:!0,barcode:!0,categoryId:!0,costPrice:!0}}}},customer:{select:{id:!0,name:!0,code:!0}},user:{select:{id:!0,fullName:!0,username:!0}}},orderBy:{createdAt:"desc"}}),t=await A.prisma.return.findMany({where:{createdAt:{gte:u,lte:c}},include:{items:{include:{product:{select:{id:!0,name:!0,barcode:!0}}}}}}),r=e.reduce((e,t)=>e+t.finalAmount,0),a=t.reduce((e,t)=>e+t.totalAmount,0),n=r-a,o=e.reduce((e,t)=>e+t.discount,0),s=e.reduce((e,t)=>e+t.tax,0),i=e.reduce((e,t)=>{let r=t.items.reduce((e,t)=>e+t.product.costPrice*t.quantity,0);return e+r},0),l=new Map;e.forEach(e=>{e.items.forEach(e=>{let t=e.productId,r=l.get(t);r?(r.quantity+=e.quantity,r.revenue+=e.totalPrice):l.set(t,{product:e.product,quantity:e.quantity,revenue:e.totalPrice})})}),t.forEach(e=>{e.items.forEach(e=>{let t=e.productId,r=l.get(t);r&&(r.quantity-=e.quantity,r.revenue-=e.totalPrice)})});let d=Array.from(l.values()).filter(e=>e.quantity>0).sort((e,t)=>t.revenue-e.revenue).slice(0,10),p=new Map;t.forEach(e=>{e.items.forEach(e=>{let t=e.productId,r=p.get(t);r?(r.quantity+=e.quantity,r.amount+=e.totalPrice):p.set(t,{product:e.product,quantity:e.quantity,amount:e.totalPrice})})});let m=Array.from(p.values()).sort((e,t)=>t.quantity-e.quantity).slice(0,10),h=Array.from({length:24},(t,r)=>{let a=e.filter(e=>new Date(e.createdAt).getHours()===r);return{hour:r,sales:a.length,revenue:a.reduce((e,t)=>e+t.finalAmount,0)}}),y=new Map;e.forEach(e=>{let t=(0,E.format)(new Date(e.createdAt),"yyyy-MM-dd"),r=y.get(t);r?(r.sales++,r.revenue+=e.finalAmount):y.set(t,{date:t,sales:1,revenue:e.finalAmount})});let f=e.reduce((e,t)=>{let r=t.paymentMethod||"unknown";return e[r]||(e[r]={count:0,amount:0}),e[r].count++,e[r].amount+=t.finalAmount,e},{}),g={cash:f.cash?.amount||0,creditCard:f.creditCard?.amount||0};return w.NextResponse.json({success:!0,type:"sales",period:{start:u,end:c},summary:{totalSales:e.length,totalReturns:t.length,netSales:e.length-t.length,totalRevenue:r,totalReturnsAmount:a,netRevenue:n,totalDiscount:o,totalTax:s,totalCost:i,grossProfit:r-i,netProfit:n-i,averageOrderValue:e.length>0?r/e.length:0,totalItems:e.reduce((e,t)=>e+t.items.length,0)},topProducts:d,topReturnedProducts:m,hourlyBreakdown:h,dailyBreakdown:Array.from(y.values()),dailySales:Array.from(y.values()),paymentMethods:f,paymentMethodBreakdown:g,sales:e.slice(0,100),returns:t.slice(0,50)})}case"stock":{let e=await A.prisma.product.findMany({where:{isActive:!0},include:{category:{select:{id:!0,name:!0}},supplier:{select:{id:!0,name:!0,code:!0}}},orderBy:{name:"asc"}}),t=e.reduce((e,t)=>e+t.price*t.stock,0),r=e.reduce((e,t)=>e+t.costPrice*t.stock,0),a=e.filter(e=>e.stock<=e.minStock&&e.stock>0),n=e.filter(e=>0===e.stock),o=e.filter(e=>{if(!e.expiryDate)return!1;let t=Math.ceil((new Date(e.expiryDate).getTime()-new Date().getTime())/864e5);return t<=30&&t>=0}),s=e.reduce((e,t)=>{let r=t.category?.name||"Uncategorized";return e[r]||(e[r]={category:t.category,products:0,totalStock:0,totalValue:0,totalCostValue:0}),e[r].products++,e[r].totalStock+=t.stock,e[r].totalValue+=t.price*t.stock,e[r].totalCostValue+=t.costPrice*t.stock,e},{}),i=await A.prisma.stockMovement.findMany({where:{createdAt:{gte:u,lte:c}},include:{product:{select:{id:!0,name:!0,barcode:!0}}},orderBy:{createdAt:"desc"},take:100}),l={totalIn:i.filter(e=>"in"===e.type).reduce((e,t)=>e+t.quantity,0),totalOut:i.filter(e=>"out"===e.type).reduce((e,t)=>e+t.quantity,0),totalAdjustments:i.filter(e=>"adjustment"===e.type).reduce((e,t)=>e+Math.abs(t.quantity),0),totalWaste:i.filter(e=>"waste"===e.type).reduce((e,t)=>e+t.quantity,0)};return w.NextResponse.json({success:!0,type:"stock",period:{start:u,end:c},summary:{totalProducts:e.length,totalStock:e.reduce((e,t)=>e+t.stock,0),totalValue:t,totalCostValue:r,potentialProfit:t-r,lowStockCount:a.length,outOfStockCount:n.length,expiringCount:o.length},lowStockProducts:a.slice(0,50),outOfStockProducts:n.slice(0,50),expiringProducts:o.map(e=>({...e,daysUntilExpiry:e.expiryDate?Math.ceil((new Date(e.expiryDate).getTime()-new Date().getTime())/864e5):null})),categoryBreakdown:Object.values(s),movementSummary:l,recentMovements:i})}case"profit":{let e=await A.prisma.sale.findMany({where:{createdAt:{gte:u,lte:c},status:"completed"},include:{items:{include:{product:{select:{costPrice:!0}}}}}}),t=await A.prisma.purchase.findMany({where:{createdAt:{gte:u,lte:c}}}),r=await A.prisma.return.findMany({where:{createdAt:{gte:u,lte:c}}}),a=await A.prisma.cashTransaction.findMany({where:{createdAt:{gte:u,lte:c},type:"expense"}}),n=e.reduce((e,t)=>e+t.finalAmount,0),o=e.reduce((e,t)=>{let r=t.items.reduce((e,t)=>e+t.product.costPrice*t.quantity,0);return e+r},0),s=t.reduce((e,t)=>e+t.finalAmount,0),i=r.reduce((e,t)=>e+t.totalAmount,0),l=a.reduce((e,t)=>e+t.amount,0),d=n-o,p=d-l-i,m=new Map;e.forEach(e=>{let t=(0,E.format)(new Date(e.createdAt),"yyyy-MM-dd"),r=e.items.reduce((e,t)=>e+t.product.costPrice*t.quantity,0),a=m.get(t);a?(a.revenue+=e.finalAmount,a.cost+=r,a.profit+=e.finalAmount-r):m.set(t,{date:t,revenue:e.finalAmount,cost:r,profit:e.finalAmount-r})});let h=new Map;e.forEach(e=>{let t=(0,E.format)(new Date(e.createdAt),"yyyy-MM"),r=e.items.reduce((e,t)=>e+t.product.costPrice*t.quantity,0),a=h.get(t);a?(a.revenue+=e.finalAmount,a.cost+=r,a.profit+=e.finalAmount-r,a.salesCount++):h.set(t,{month:t,revenue:e.finalAmount,cost:r,profit:e.finalAmount-r,salesCount:1})});let y=new Map;e.forEach(e=>{e.items.forEach(e=>{let t=e.productId,r=y.get(t),a=e.product.costPrice*e.quantity,n=e.totalPrice-a;r?(r.quantitySold+=e.quantity,r.revenue+=e.totalPrice,r.cost+=a,r.profit+=n):y.set(t,{product:e.product,quantitySold:e.quantity,revenue:e.totalPrice,cost:a,profit:n,currentStock:0,turnoverRate:0})})});let f=Array.from(y.keys());f.length>0&&(await A.prisma.product.findMany({where:{id:{in:f}},select:{id:!0,name:!0,barcode:!0,stock:!0}})).forEach(e=>{let t=y.get(e.id);t&&(t.currentStock=e.stock,t.product=e,t.turnoverRate=t.currentStock>0?t.quantitySold/t.currentStock:t.quantitySold)});let g=Array.from(y.values()).filter(e=>e.quantitySold>0).sort((e,t)=>t.turnoverRate-e.turnoverRate).slice(0,10).map(e=>({product:e.product,quantitySold:e.quantitySold,currentStock:e.currentStock,turnoverRate:e.turnoverRate,revenue:e.revenue})),v=Array.from(y.values()).filter(e=>e.turnoverRate<.5&&e.currentStock>0).sort((e,t)=>e.turnoverRate-t.turnoverRate).slice(0,10).map(e=>({product:e.product,quantitySold:e.quantitySold,currentStock:e.currentStock,turnoverRate:e.turnoverRate,daysInStock:Math.ceil((c.getTime()-u.getTime())/864e5)}));return w.NextResponse.json({success:!0,type:"profit",period:{start:u,end:c},summary:{totalRevenue:n,totalCost:o,grossProfit:d,netProfit:p,grossProfitMargin:n>0?d/n*100:0,netProfitMargin:n>0?p/n*100:0,totalPurchases:s,totalReturns:i,totalExpenses:l,salesCount:e.length,averageProfit:e.length>0?d/e.length:0},dailyProfit:Array.from(m.values()),monthlyTrend:Array.from(h.values()),topTurnoverProducts:g,slowMovers:v,expenses:a.map(e=>({id:e.id,category:e.category,amount:e.amount,description:e.description,createdAt:e.createdAt}))})}case"customer":{let e=await A.prisma.customer.findMany({where:{isActive:!0},include:{sales:{where:{createdAt:{gte:u,lte:c},status:"completed"}},returns:{where:{createdAt:{gte:u,lte:c}}},_count:{select:{sales:!0,returns:!0}}}}),t=e.map(e=>{let t=e.sales.reduce((e,t)=>e+t.finalAmount,0),r=e.returns.reduce((e,t)=>e+t.totalAmount,0),a=e.sales.length;return{id:e.id,code:e.code,name:e.name,customerType:e.customerType,loyaltyPoints:e.loyaltyPoints,currentBalance:e.currentBalance,totalSpent:t,totalReturns:r,netSpent:t-r,purchaseCount:a,averageOrderValue:a>0?t/a:0,lastPurchase:e.sales.length>0?e.sales[e.sales.length-1].createdAt:null}}).filter(e=>e.purchaseCount>0),r=t.sort((e,t)=>t.netSpent-e.netSpent).slice(0,20),a=t.reduce((e,t)=>{let r=t.customerType||"retail";return e[r]||(e[r]={count:0,totalSpent:0,averageSpent:0}),e[r].count++,e[r].totalSpent+=t.netSpent,e},{});Object.keys(a).forEach(e=>{a[e].averageSpent=a[e].totalSpent/a[e].count});let n=e.filter(e=>e.currentBalance>0).map(e=>({id:e.id,code:e.code,name:e.name,currentBalance:e.currentBalance,creditLimit:e.creditLimit})).sort((e,t)=>t.currentBalance-e.currentBalance),o=n.reduce((e,t)=>e+t.currentBalance,0);return w.NextResponse.json({success:!0,type:"customer",period:{start:u,end:c},summary:{totalCustomers:e.length,activeCustomers:t.length,totalRevenue:t.reduce((e,t)=>e+t.netSpent,0),averageCustomerValue:t.length>0?t.reduce((e,t)=>e+t.netSpent,0)/t.length:0,totalLoyaltyPoints:e.reduce((e,t)=>e+t.loyaltyPoints,0),totalDebt:o,customersWithDebt:n.length},topCustomers:r,typeBreakdown:a,customersWithDebt:n.slice(0,50)})}case"supplier":{let e=await A.prisma.supplier.findMany({where:{isActive:!0},include:{purchases:{where:{createdAt:{gte:u,lte:c}}},products:{select:{id:!0,name:!0,stock:!0,price:!0,costPrice:!0}},_count:{select:{purchases:!0,products:!0}}}}),t=e.map(e=>{let t=e.purchases.reduce((e,t)=>e+t.finalAmount,0),r=e.purchases.reduce((e,t)=>e+t.paidAmount,0),a=e.products.reduce((e,t)=>e+t.stock*t.price,0);return{id:e.id,code:e.code,name:e.name,contactPerson:e.contactPerson,phone:e.phone,email:e.email,currentBalance:e.currentBalance,paymentTerm:e.paymentTerm,totalPurchased:t,totalPaid:r,outstandingPayment:t-r,purchaseCount:e.purchases.length,productCount:e.products.length,productValue:a,lastPurchase:e.purchases.length>0?e.purchases[e.purchases.length-1].createdAt:null}}).filter(e=>e.purchaseCount>0),r=t.sort((e,t)=>t.totalPurchased-e.totalPurchased).slice(0,20),a=t.filter(e=>e.outstandingPayment>0).sort((e,t)=>t.outstandingPayment-e.outstandingPayment),n=a.reduce((e,t)=>e+t.outstandingPayment,0);return w.NextResponse.json({success:!0,type:"supplier",period:{start:u,end:c},summary:{totalSuppliers:e.length,activeSuppliers:t.length,totalPurchased:t.reduce((e,t)=>e+t.totalPurchased,0),totalPaid:t.reduce((e,t)=>e+t.totalPaid,0),totalOutstanding:n,suppliersWithOutstanding:a.length,totalProducts:t.reduce((e,t)=>e+t.productCount,0)},topSuppliers:r,suppliersWithOutstanding:a.slice(0,50)})}default:return w.NextResponse.json({error:"Invalid report type. Valid types: sales, stock, profit, customer, supplier"},{status:400})}}catch(e){if(console.error("Error generating report:",e),"P1000"===e.code||e.message?.includes("Authentication failed"))return w.NextResponse.json({success:!1,error:"Database connection failed",details:e.message},{status:503});return w.NextResponse.json({success:!1,error:"Failed to generate report",message:e.message},{status:500})}}e.s(["GET",()=>C],92600);var x=e.i(92600);let q=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/reports/route",pathname:"/api/reports",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/Downloads/dark-1/barkod/app/api/reports/route.ts",nextConfigOutput:"standalone",userland:x}),{workAsyncStorage:M,workUnitAsyncStorage:D,serverHooks:T}=q;function N(){return(0,a.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:D})}async function b(e,t,a){q.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/reports/route";w=w.replace(/\/index$/,"")||"/";let A=await q.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!A)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:P,nextConfig:S,parsedUrl:k,isDraftMode:E,prerenderManifest:C,routerServerContext:x,isOnDemandRevalidate:M,revalidateOnlyGenerated:D,resolvedPathname:T,clientReferenceManifest:N,serverActionsManifest:b}=A,O=(0,u.normalizeAppPath)(w),I=!!(C.dynamicRoutes[O]||C.routes[T]),_=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,k,!1):t.end("This page could not be found"),null);if(I&&!E){let e=!!C.routes[T],t=C.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await _();throw new g.NoFallbackError}}let j=null;!I||q.isDev||E||(j="/index"===(j=T)?"/":j);let B=!0===q.isDev||!I,H=I&&!B;b&&N&&(0,s.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:N,serverActionsManifest:b,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:b})});let U=e.method||"GET",V=(0,o.getTracer)(),F=V.getActiveScopeSpan(),$={params:P,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:B,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>q.onRequestError(e,t,a,x)},sharedContext:{buildId:R}},K=new c.NodeNextRequest(e),L=new c.NodeNextResponse(t),W=l.NextRequestAdapter.fromNodeNextRequest(K,(0,l.signalFromNodeResponse)(t));try{let s=async e=>q.handle(W,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=V.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${w}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),u=async n=>{var o,u;let c=async({previousCacheEntry:r})=>{try{if(!i&&M&&D&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await s(n);e.fetchMetrics=$.renderOpts.fetchMetrics;let u=$.renderOpts.pendingWaitUntil;u&&a.waitUntil&&(a.waitUntil(u),u=void 0);let c=$.renderOpts.collectedTags;if(!I)return await (0,m.sendResponse)(K,L,o,$.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,a=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:M})},x),t}},l=await q.handleResponse({req:e,nextConfig:S,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:M,revalidateOnlyGenerated:D,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:i});if(!I)return null;if((null==l||null==(o=l.value)?void 0:o.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(u=l.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",M?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,h.fromNodeOutgoingHttpHeaders)(l.value.headers);return i&&I||d.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,y.getCacheControlHeader)(l.cacheControl)),await (0,m.sendResponse)(K,L,new Response(l.value.body,{headers:d,status:l.value.status||200})),null};F?await u(F):await V.withPropagatedContext(e.headers,()=>V.trace(d.BaseServerSpan.handleRequest,{spanName:`${U} ${w}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},u))}catch(t){if(t instanceof g.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:M})}),I)throw t;return await (0,m.sendResponse)(K,L,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>N,"routeModule",()=>q,"serverHooks",()=>T,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>D],78513)}];

//# sourceMappingURL=edace_next_dist_esm_build_templates_app-route_82c68a5b.js.map